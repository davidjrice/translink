<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml"> 
  <head> 
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/> 
    <title>Maps</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=true&amp;key=ABQIAAAACc___sNvSynSaWkB8BkrWBQ2d4m_eQjJyB961KEaj_DVihhfaRS3uin1mlpNqct_f5R6Sh4Hq9nygQ" type="text/javascript"></script>
    <!-- Development 
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=true&amp;key=ABQIAAAACc___sNvSynSaWkB8BkrWBS5WX_aIvwO_e1XNZP97lgHspfiLxRdNFe6vhkheA29Pd6wxcQWYBu0mA" type="text/javascript"></script>
      Production
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=true&amp;key=ABQIAAAACc___sNvSynSaWkB8BkrWBQ2d4m_eQjJyB961KEaj_DVihhfaRS3uin1mlpNqct_f5R6Sh4Hq9nygQ" type="text/javascript"></script>
      
    -->
    <script src="/data/routes-new.json"></script>
    <script src="/data/stops.json"></script>
    <script src="/js/mustache.js" type="text/javascript"></script>
    
    <script>
      var map = null;
      var markers = {};
      var area = "1";
      var service = "A";
      
      function initialize() {
        if (GBrowserIsCompatible()) {
          map = new GMap2(document.getElementById("map_canvas"), {zoom: 16});
          map.setCenter(new GLatLng(54.596571, -5.930235), 13);
          map.addControl(new GSmallMapControl());
          map.addControl(new GMapTypeControl());
        
          //var route_data = myTranslink[area][service]["I"];
          //drawRoute(map, route_data);
        }
      }
      
      function drawRoute(map, route_data){
        for (var stop in route_data) {
          var s = myTranslinkStops[route_data[stop]];
          var latlng = new GLatLng(s.lat, s.lon);
          var marker = new GMarker(latlng, {title: s.name});
          markers[stop] = marker;
          map.addOverlay(marker);
          addDebugWindow(marker, stop, s.name);
        }
      }
      function addDebugWindow(marker, stop_number, name) {
        GEvent.addListener(marker, "click", function() {
          marker.openInfoWindow("#" + stop_number + " " + name);
        });
      }
      
      function draw_route(area, service, route){
        var route_data = myTranslink[area][service][route];
        drawRoute(map, route_data);
      }
      
      function update_routes(){
        data = ["Inbound", "Outbound", "X"]
        $('#route').empty();
        $.each(data, function(i,item){
          var template = "<input type='checkbox' name='{{code}}' value='{{code}}'><label>{{name}}</label>";
          var view = { code: item.substring(0,1), name: item };
          var html = Mustache.to_html(template, view);                
          $('#route').append(html);
        });
        
        $("#route").live("change",function(){
          area = $('#area').val();
          service = $('#service').val();
          
          // Remove unchecked routes.
          $.each($("#route input"), function(i,item){
            if($(item).attr('checked') == false){
              stops = myTranslink[area][service][$(item).val()]
              for (var stop in stops) {
                if( markers[stop] ){
                 map.removeOverlay(markers[stop]) 
                }
              }
            }
          });
          
          //var route = $('#route').val();
          $.each($("input:checked"), function(i,item){
            var route = item.name;
            draw_route(area, service, route);
          });
        });
      }
      
      function update_services(data){
        $.each(markers, function(i,item){
          map.removeOverlay(item)
        });
        
        $('#service').empty();
        var area = $('#area').val();
        var services = data[area];
        $.each(services, function(service,routes){
          var template = "<option value='{{service}}'>{{service}}</option>";
          var view = { service: service };
          var html = Mustache.to_html(template, view);                
          $('#service').append(html);
        });
        
        var service = $('#service').val();
        update_routes();
      }
      
      $(document).ready(function() {
        initialize();
        
        var areas = [];
        var services = {};
        
        $.getJSON('/data/areas.json', function(data) {
          $.each(data, function(i,item){
            var template = "<option value='{{code}}'>{{code}} - {{name}}</option>";
            var view = {
              code: item['code'],
              name: item['name']
            };
            var html = Mustache.to_html(template, view);
            areas.push(item);
            $('#area').append(html);
          });
          //$('#area').html('<option value="+'data['code']'">'+data['name']+'</option>');
          
          $.getJSON('/data/services.json', function(data){
            services = data;
            update_services(services);
          });
          
          
          $("#area").live("change",function(){
            update_services(services);
          });
        });        
        
        
      });
    </script> 
  </head> 
  <body>
    <h1>Translink Metro Stops</h1>
    <select id="area"></select>
    <select id="service"></select>
    <div id="route"></div>
    <div id="map_canvas" style="width: 100%; height: 600px; display: block; margin-top:50px"></div> 
  </body> 
</html>